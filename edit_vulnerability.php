<?php
include 'db_connect.php';

// Accept `vid` from URL
$vid = isset($_GET['vid']) ? intval($_GET['vid']) : (isset($_GET['id']) ? intval($_GET['id']) : 0);
if ($vid <= 0) {
    die("‚ùå Invalid vulnerability ID.");
}

$status = "";

// ‚úÖ Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $vname     = $_POST['vname'];
    $vlevel    = $_POST['vlevel'];
    $vlevelno  = $_POST['vlevelno'];
    $vpara     = $_POST['vpara'];
    $vdesc     = $_POST['vdesc'];
    $vimpact   = $_POST['vimpact'];
    $vcve      = $_POST['vcve'];
    $vsolu     = $_POST['vsolu'];
    $vremarks  = $_POST['vremarks'];

    $stmt = $conn->prepare("UPDATE vul SET vname=?, vlevel=?, vlevelno=?, vpara=?, vdesc=?, vimpact=?, vcve=?, vsolu=?, vremarks=? WHERE vid=?");
    $stmt->bind_param("ssissssssi", $vname, $vlevel, $vlevelno, $vpara, $vdesc, $vimpact, $vcve, $vsolu, $vremarks, $vid);

    if ($stmt->execute()) {
        header("Location: vapt_final_report.php?updated=1");
        exit();
    } else {
        $status = "‚ùå Error: " . $stmt->error;
    }

    $stmt->close();
}

// ‚úÖ Fetch vulnerability data
$stmt = $conn->prepare("SELECT * FROM vul WHERE vid = ?");
$stmt->bind_param("i", $vid);
$stmt->execute();
$result = $stmt->get_result();
$vuln = $result->fetch_assoc();
$stmt->close();

if (!$vuln) {
    die("‚ùå Vulnerability not found.");
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Edit Vulnerability</title>
    <style>
        body { font-family: Arial; background: #f8f8f8; padding: 40px; }
        form { max-width: 750px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
        textarea, input, select { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; }
        button { background: #007b83; color: white; padding: 10px 20px; margin-top: 20px; border: none; border-radius: 6px; cursor: pointer; }
        h2 { color: #007b83; text-align: center; }
        .status { text-align: center; font-weight: bold; color: green; }
        a.back { text-decoration: none; display: inline-block; margin-top: 20px; color: #007b83; }
    </style>
</head>
<body>

<h2>‚úèÔ∏è Edit Vulnerability</h2>

<?php if ($status): ?>
    <p class="status"><?= $status ?></p>
<?php endif; ?>

<form method="post">
    <label>Vulnerability Name:</label>
    <input type="text" name="vname" value="<?= htmlspecialchars($vuln['vname']) ?>" required>

    <label>Severity Level:</label>
    <select name="vlevel" required>
        <option value="">Select</option>
        <option value="informational" <?= $vuln['vlevel'] === 'informational' ? 'selected' : '' ?>>Informational</option>
        <option value="Low" <?= $vuln['vlevel'] === 'Low' ? 'selected' : '' ?>>Low</option>
        <option value="Medium" <?= $vuln['vlevel'] === 'Medium' ? 'selected' : '' ?>>Medium</option>
        <option value="High" <?= $vuln['vlevel'] === 'High' ? 'selected' : '' ?>>High</option>
        <option value="Critical" <?= $vuln['vlevel'] === 'Critical' ? 'selected' : '' ?>>Critical</option>
    </select>

    <label>Severity Level Number:</label>
    <input type="number" name="vlevelno" value="<?= htmlspecialchars($vuln['vlevelno']) ?>" required>

    <label>Parameters:</label>
    <textarea name="vpara"><?= htmlspecialchars($vuln['vpara']) ?></textarea>

    <label>Description:</label>
    <textarea name="vdesc"><?= htmlspecialchars($vuln['vdesc']) ?></textarea>

    <label>Impact:</label>
    <textarea name="vimpact"><?= htmlspecialchars($vuln['vimpact']) ?></textarea>

    <label>CVE Reference:</label>
    <input type="text" name="vcve" value="<?= htmlspecialchars($vuln['vcve']) ?>">

    <label>Solution:</label>
    <textarea name="vsolu"><?= htmlspecialchars($vuln['vsolu']) ?></textarea>

    <label>Remarks:</label>
    <textarea name="vremarks"><?= htmlspecialchars($vuln['vremarks']) ?></textarea>

    <button type="submit">üíæ Save Changes</button>
    <a href="manage_vulnerabilities.php" class="back">‚¨Ö Back to Report</a>
</form>

</body>
</html>
